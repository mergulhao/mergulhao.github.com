<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Um pouco de migrações - Rails migrations &mdash; Por Sylvestre Mergulhão</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link href='/assets/stylesheets/reset.css' rel='stylesheet' media="all" />
  <link href='/assets/stylesheets/global.css' rel='stylesheet' media="all" />
  <link href='http://fonts.googleapis.com/css?family=Raleway:200|Source+Sans+Pro:400,300,600' rel='stylesheet' type='text/css' />

  <link href='/favicon.png' rel='shortcut icon' />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src='/assets/javascripts/scripts.js'></script>

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1780029-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
<body>
  <article>
    <a href="#" id="show-info">sobre &#8595;</a>
    <header>
      
        <a id="brand" href="/">
          <hgroup>
            <h1>Mergulhao.info</h1>
            <h2>Por Sylvestre Mergulhão</h2>
          </hgroup>
        </a>
      

      <form class="navbar-search pull-right visible-desktop" action="http://www.google.com/cse">
        <input type="hidden" name="cx" value="010524361318296033268:c-e-2ijyy_i" />
        <input type="hidden" name="cof" value="FORID:0" />
        <input name="q" class="search-query" type="text" placeholder="buscar por..." />
      </form>

      <p id="about"><img src="/assets/images/mergulhao-thumb.png" alt="Foto de Sylvestre Mergulhão" /> Sylvestre Mergulhão é empreendedor e programador. Fundador do <a href="http://startupdev.com.br">Startup DEV</a> e sócio da <a href="http://helabs.com.br/">HE:labs</a>.</p>

      <ul>
        <li><a href="http://startupdev.com.br" id="startupdev-link">Startup DEV</a></li>
        <li><a href="http://helabs.com.br/" id="helabs-link">HE:labs</a></li>
      </ul>
    </header>
    <hr />
    <section role="main">
      <hgroup>
  <h1>Um pouco de migrações - Rails migrations</h1>
  <h2>Postado em 03/06/2007</h2>
</hgroup>



<p>Para acompanhar a evolução da sua base de dados, no Rails, existem as migrações. Migrações nada mais são do que scripts escritos em linguagem Ruby e que utilizam API disponibilizada pelo Rails para criação, alteração de tabelas do banco de dados. Tal qual as outras operações do ActiveRecord, as migrações também são códigos independentes do SGBD que está utilizando. Com isso ela permite facilmente a migração da aplicação para outro SGBD. São fortes aliadas no desenvolvimento incremental.</p>

<p>Ao criar um modelo usando o <em>generate</em>, temos:</p>

<pre><code>  $ script/generate model client
  exists  app/models/
  exists  test/unit/
  exists  test/fixtures/
  create  app/models/client.rb
  create  test/unit/client_test.rb
  create  test/fixtures/clients.yml
  create  db/migrate
  create  db/migrate/001_create_clients.rb</code></pre>

<p>Reparem no arquivo <em>db/migrate/001_create_clients.rb</em> que foi criado. Editando ele, temos:</p>

<pre><code>  class CreateClients &lt; ActiveRecord::Migration
    def self.up
      create_table :clients do |t|
      end
    end

    def self.down
      drop_table :clients
    end
  end</code></pre>

<p>Vamos supor que gostaríamos de ter para o nosso client os atributos, <em>name</em>, <em>birth</em> e <em>email</em>. Então alteramos o arquivo para:</p>

<pre><code>  class CreateClients &lt; ActiveRecord::Migration
    def self.up
      create_table :clients do |t|
        t.column :name, :string
        t.column :birth, :date
        t.column :email, :string
      end
    end

    def self.down
      drop_table :clients
    end
  end</code></pre>

<p>Agora para rodar a migração(a base de dados já deve existir e estar configurada no database.yml):</p>

<pre><code>  rake db:migrate</code></pre>

<p>Verificando em nosso banco de dados temos a tabela criada com os campos que desejamos e também a tabela <em>schema_info</em>, que serve para o controle da versão em que o banco se encontra.</p>

<p>Se em determinado ponto do projeto fosse necessário adicionar um novo atributo para nosso client, então procederíamos assim:</p>

<pre><code>  script/generate migration add_sex_to_client</code></pre>

<p>Agora editando o arquivo <em>db/migrate/002_add_sex_to_client.rb</em> que foi criado, deixamos assim:</p>

<pre><code>  class AddSexToClient &lt; ActiveRecord::Migration
    def self.up
      add_column :clients, :sex, :string
    end

    def self.down
      remove_column :clients, :sex
    end
  end</code></pre>

<p>E para rodar a migração:</p>

<pre><code>  rake db:migrate</code></pre>

<p>É importante manter sempre consiso o método <em>self_down</em>, para que seja possível retornar à base para versões anteriores, mas é claro que existem situações onde não há como reverter a migração. Para atualizar o banco com uma migração específica:</p>

<pre><code>  rake db:migrate VERSION=1</code></pre>

<p>Nas migrações também podem ser adicionados dados no banco utilizando os próprios modelos(_models_) da sua aplicação Rails. Mas é preciso ficar atento quando à utilização indiscriminada desse recurso, pois eventualmente se esse modelo deixa de existir ou se os métodos utilizados são modificados, a sua migração pode ficar quebrada e incapaz de subir um banco do zero até a última revisão.</p>

<p>Alguns links com mais informações:</p>

<p><a href='http://api.rubyonrails.org/classes/ActiveRecord/Migration.html'>Api Rails</a> <br /><a href='http://www.ibm.com/developerworks/java/library/j-cb08156.html'>Crossing borders: Rails migrations</a></p>


  <div class="tags">
  
    <a href="/tags/#rails">rails</a>
  
  </div>

<div class="well">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'mergulhaoinfo';
      var disqus_url = 'http://mergulhao.info/2007/6/3/um-pouco-de-migracoes/';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </section>
    <hr />
    <footer>
      <div id="go-to-top"><a href="#">&#8593; topo</a></div>
      <p id="copy">Copyright &copy; 2012 Mergulhao.info</p>
      <p>Veja minhas palestras no <a href="https://speakerdeck.com/u/mergulhao" rel="external">Speaker Deck</a> e me acompanhe também no twitter <a href="http://twitter.com/smergulhao" target="_blank" rel="external,nofollow">@smergulhao</a>.</p>
      <p><a href="http://pt.wikipedia.org/wiki/Rio_de_Janeiro_%28cidade%29" rel="external,nofollow">Rio de Janeiro</a>, <a href="http://pt.wikipedia.org/wiki/Brasil" rel="external,nofollow">Brasil</a>.</p>
    </footer>
  </article>
</body>
</html>