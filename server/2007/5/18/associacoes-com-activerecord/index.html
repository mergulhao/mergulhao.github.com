<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Associações com ActiveRecord &mdash; Por Sylvestre Mergulhão</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link href='/assets/stylesheets/reset.css' rel='stylesheet' media="all" />
  <link href='/assets/stylesheets/global.css' rel='stylesheet' media="all" />
  <link href='http://fonts.googleapis.com/css?family=Raleway:200|Source+Sans+Pro:400,300,600' rel='stylesheet' type='text/css' />

  <link href='/favicon.png' rel='shortcut icon' />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src='/assets/javascripts/scripts.js'></script>

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1780029-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
<body>
  <article>
    <a href="#" id="show-info">sobre &#8595;</a>
    <header>
      
        <a id="brand" href="/">
          <hgroup>
            <h1>Mergulhao.info</h1>
            <h2>Por Sylvestre Mergulhão</h2>
          </hgroup>
        </a>
      

      <form class="navbar-search pull-right visible-desktop" action="http://www.google.com/cse">
        <input type="hidden" name="cx" value="010524361318296033268:c-e-2ijyy_i" />
        <input type="hidden" name="cof" value="FORID:0" />
        <input name="q" class="search-query" type="text" placeholder="buscar por..." />
      </form>

      <p id="about"><img src="/assets/images/mergulhao-thumb.png" alt="Foto de Sylvestre Mergulhão" /> Sylvestre Mergulhão é empreendedor e programador. Fundador do <a href="http://startupdev.com.br">Startup DEV</a> e sócio da <a href="http://helabs.com.br/">HE:labs</a>.</p>

      <ul>
        <li><a href="http://startupdev.com.br" id="startupdev-link">Startup DEV</a></li>
        <li><a href="http://helabs.com.br/" id="helabs-link">HE:labs</a></li>
      </ul>
    </header>
    <hr />
    <section role="main">
      <hgroup>
  <h1>Associações com ActiveRecord</h1>
  <h2>Postado em 18/05/2007</h2>
</hgroup>



<p>Vou contar um pouco da minha experiência com o ActiveRecord do Rails. Trata-se do <em>has and belongs to many</em> - hbtm - e do <em>has many through</em>, inserido no Rails 1.1.</p>

<p>As associações hbtm são resultado de relações muitos para muitos - ou n para n - entre duas tabelas do banco de dados. Por exemplo, imagine um livro. Esse livro pode ser enquadrado em diversas categorias simultaneamente. Reciprocamente, uma categoria pode possuir diversos livros enquadrados. Nesse caso teríamos duas classes de modelo:</p>

<pre><code>class Book &lt; ActiveRecord::Base  
  has_and_belongs_to_many :categories  
end  </code></pre>

<p>e</p>

<pre><code>class Category &lt; ActiveRecord::Base  
  has_and_belongs_to_many :books  
end  </code></pre>

<p>E temos o modelo de dados:</p>

<p>p{text-align: center}. <img alt='activerecord1.png' src='http://mergulhao.info/assets/images/2007/5/18/activerecord1.png' style='border: 0px;' /></p>

<p>A tabela <em>books_categories</em> não precisa de modelo. Ela é mapeada automaticamente pelo <em>has_and_belongs_to_many</em>. Para adicionar uma categoria a um livro:</p>

<pre><code>book.categories &lt;&lt; Category.find(1)
book.save</code></pre>

<p>E para recuperar todos os livros de uma categoria pode-se fazer:</p>

<pre><code>books = Category.find(1).books</code></pre>

<p>Dentro da variável <em>books</em> estarão todos os livros(um array de livros) que pertencem a categoria com id igual a 1. O mesmo vale no sentido contrário:</p>

<pre><code>categories = Book.find(1).categories</code></pre>

<p>A variável <em>categories</em> será um array das categorias a qual o livro com id igual a 1 pertence. Simples não?</p>

<p>Mas e se o relacionamento em si possuir atributos também? No nosso caso, isso significa a tabela <em>books_categories</em> possuir atributos que pertencem ao relacionamento, e não a categoria ou ao livro isoladamente. Esse caso não é tratado pelo <em>has and belongs to many</em>. É aí que entra o <em>has many through</em>.</p>

<p>Alterando o modelo de dados para:</p>

<p>p{text-align: center}. <img alt='activerecord1.png' src='http://mergulhao.info/assets/images/2007/5/18/activerecord2.png' style='border: 0px;' /></p>

<p>Temos agora a substituição da tabela <em>books_categories</em> pela tabela <em>comments</em>, que provê as mesmas informações da anterior e mais um comentário. Então agora cada livro possui um comentário que por sua vez está associado a uma categoria. Esse comentário poderia ser usado, por exemplo, para explicar por que a pessoa que cadastrou o livro incluiu-o naquela categoria. Os modelos ficam agora:</p>

<pre><code>class Book &lt; ActiveRecord::Base  
  has_many :comments  
  has_many :categories, :through =&gt; :comments
end  


class Comment &lt; ActiveRecord::Base  
  belongs_to :book  
  belongs_to :category  
end  


class Category &lt; ActiveRecord::Base  
  has_many :books, :through =&gt; :comments    
end  </code></pre>

<p>Agora podemos fazer coisas como:</p>

<pre><code>category = Category.find(1)
comment = Comment.new :content =&gt; &quot;meu comentario&quot;, :category =&gt; category
book.comments &lt;&lt; comment
book.save</code></pre>

<p>Ou apenas:</p>

<pre><code>book.categories &lt;&lt; Category.find(1)</code></pre>

<p>E o comentário virá em branco. Pode-se também:</p>

<pre><code>books = Category.find(1).books</code></pre>

<p>Que retornará todos os livros pertencentes a uma categoria. Podemos também:</p>

<pre><code>categories = Books.find(1).categories</code></pre>

<p>Onde teremos todas as categorias de um livro. Além disso:</p>

<pre><code>comments = Books.find(1).comments</code></pre>

<p>Onde teremos todos os comentários de um livro. Lembrando que cada objeto <em>comment</em> ainda possui a categoria associada a ele.</p>

<p>Para testar as coisas e garantir que o código que eu escrevi aqui estava ok, no fim eu resolvi testá-lo. E usei migração para geração da base de dados, como forma fácil de <em>migrar</em> do primeiro modelo para o segundo. Então esse poderá ser o tema do próximo post.</p>

<p>Por favor, se encontrar qualquer erro nas informações ou no código, não exite em informar nos comentários para que eu possa corrigir.</p>


  <div class="tags">
  
    <a href="/tags/#rails">rails</a>
  
  </div>

<div class="well">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'mergulhaoinfo';
      var disqus_url = 'http://mergulhao.info/2007/5/18/associacoes-com-activerecord/';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </section>
    <hr />
    <footer>
      <div id="go-to-top"><a href="#">&#8593; topo</a></div>
      <p id="copy">Copyright &copy; 2012 Mergulhao.info</p>
      <p>Veja minhas palestras no <a href="https://speakerdeck.com/u/mergulhao" rel="external">Speaker Deck</a> e me acompanhe também no twitter <a href="http://twitter.com/smergulhao" target="_blank" rel="external,nofollow">@smergulhao</a>.</p>
      <p><a href="http://pt.wikipedia.org/wiki/Rio_de_Janeiro_%28cidade%29" rel="external,nofollow">Rio de Janeiro</a>, <a href="http://pt.wikipedia.org/wiki/Brasil" rel="external,nofollow">Brasil</a>.</p>
    </footer>
  </article>
</body>
</html>