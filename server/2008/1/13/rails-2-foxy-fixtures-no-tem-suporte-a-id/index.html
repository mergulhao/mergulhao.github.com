<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rails 2: Foxy Fixtures não tem suporte a id! &mdash; Por Sylvestre Mergulhão</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link href='/assets/stylesheets/reset.css' rel='stylesheet' media="all" />
  <link href='/assets/stylesheets/global.css' rel='stylesheet' media="all" />
  <link href='http://fonts.googleapis.com/css?family=Raleway:200|Source+Sans+Pro:400,300,600' rel='stylesheet' type='text/css' />

  <link href='/favicon.png' rel='shortcut icon' />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src='/assets/javascripts/scripts.js'></script>

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1780029-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
<body>
  <article>
    <a href="#" id="show-info">sobre &#8595;</a>
    <header>
      
        <a id="brand" href="/">
          <hgroup>
            <h1>Mergulhao.info</h1>
            <h2>Por Sylvestre Mergulhão</h2>
          </hgroup>
        </a>
      

      <form class="navbar-search pull-right visible-desktop" action="http://www.google.com/cse">
        <input type="hidden" name="cx" value="010524361318296033268:c-e-2ijyy_i" />
        <input type="hidden" name="cof" value="FORID:0" />
        <input name="q" class="search-query" type="text" placeholder="buscar por..." />
      </form>

      <p id="about"><img src="/assets/images/mergulhao-thumb.png" alt="Foto de Sylvestre Mergulhão" /> Sylvestre Mergulhão é empreendedor e programador. Fundador do <a href="http://startupdev.com.br">Startup DEV</a> e sócio da <a href="http://helabs.com.br/">HE:labs</a>.</p>

      <ul>
        <li><a href="http://startupdev.com.br" id="startupdev-link">Startup DEV</a></li>
        <li><a href="http://helabs.com.br/" id="helabs-link">HE:labs</a></li>
      </ul>
    </header>
    <hr />
    <section role="main">
      <hgroup>
  <h1>Rails 2: Foxy Fixtures não tem suporte a id!</h1>
  <h2>Postado em 13/01/2008</h2>
</hgroup>



<p>Essa semana no <a href='http://www.rioonrails.com.br/speeches/projeto-lucidus'>projeto Lucidus</a> passamos por um problema com as foxy fixtures do Rails 2.</p>

<p>Estávamos utilizando um modelo que possuia um autorelacionamento e outro modelo que se relacionava com o primeiro. Algo equivalente a:</p>

<pre><code>class Pessoa &lt; ActiveRecord::Base  
  belongs_to :pai, :class_name =&gt; &#39;Pessoa&#39;, :foreign_key =&gt; &#39;pai_id&#39;  
end  

class Endereco &lt; ActiveRecord::Base  
  belongs_to :pessoa  
end  </code></pre>

<p>E precisávamos criar uma fixture de pessoa que tivesse um relacionamento para outra fixture pessoa, além de uma fixture de endereço que se relacionasse com uma de pessoa. Não sabiamos que as foxy fixtures possuiam suporte a autorelacionamento então primeiro tentamos algo como:</p>

<pre><code># pessoas.yml
pai_01:
  id: 1
  nome: Nome do Pai

filho_01:
  id: 2
  nome: Nome do Filho
  pai_id: 1

# enderecos.yml
endereco_01:
  pessoa: filho_01
  rua: rua 1
  numero: 25</code></pre>

<p>Teoricamente, no carregamento das fixtures no banco, deveria fazer o apontamento correto do endereço <strong>endereco_01</strong> preenchendo o campo <strong>pessoa_id</strong> do mesmo com o id <strong>2</strong>, do <strong>filho_01</strong>. Mas não era isso que acontecia. Era preenchido um id aleatório no campo <strong>pessoa_id</strong> do <strong>endereco_01</strong>(se o banco possuisse a constraint de foreign key daria erro no carregamento, claro). Já estávamos achando que era um problema/bug(e é na verdade) das foxy fixtures, mas resolvi pesquisar no <a href='http://api.rubyonrails.com/files/vendor/rails/activerecord/CHANGELOG.html'>changelog</a> do activerecord e descobri que não há suporte a ids nas foxy fixtures, tudo deve ser indexado somente pelos nomes e há suporte a autorelacionamento. Corrigindo então fica assim:</p>

<pre><code># pessoas.yml
pai_01:
  nome: Nome do Pai

filho_01:
  nome: Nome do Filho
  pai: pai_01

# enderecos.yml
endereco_01:
  pessoa: filho_01
  rua: rua 1
  numero: 25</code></pre>

<p>Desse modo todos os ids são criados dinamicamente, e as fixtures se acham na hora do load no banco para a execução dos testes.</p>

<p><strong>Obs:</strong> Eu não testei esse código, escrevi tudo direto no editor, pode ser que exista algum erro de sintaxe ou coisa assim.</p>


  <div class="tags">
  
    <a href="/tags/#rails">rails</a>
  
  </div>

<div class="well">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'mergulhaoinfo';
      var disqus_url = 'http://mergulhao.info/2008/1/13/rails-2-foxy-fixtures-no-tem-suporte-a-id/';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </section>
    <hr />
    <footer>
      <div id="go-to-top"><a href="#">&#8593; topo</a></div>
      <p id="copy">Copyright &copy; 2012 Mergulhao.info</p>
      <p>Veja minhas palestras no <a href="https://speakerdeck.com/u/mergulhao" rel="external">Speaker Deck</a> e me acompanhe também no twitter <a href="http://twitter.com/smergulhao" target="_blank" rel="external,nofollow">@smergulhao</a>.</p>
      <p><a href="http://pt.wikipedia.org/wiki/Rio_de_Janeiro_%28cidade%29" rel="external,nofollow">Rio de Janeiro</a>, <a href="http://pt.wikipedia.org/wiki/Brasil" rel="external,nofollow">Brasil</a>.</p>
    </footer>
  </article>
</body>
</html>