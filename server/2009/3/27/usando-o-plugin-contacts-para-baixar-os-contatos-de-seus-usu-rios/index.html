<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Usando o plugin contacts para baixar os contatos de seus usuários &mdash; Por Sylvestre Mergulhão</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link href='/assets/stylesheets/reset.css' rel='stylesheet' media="all" />
  <link href='/assets/stylesheets/global.css' rel='stylesheet' media="all" />
  <link href='http://fonts.googleapis.com/css?family=Raleway:200|Source+Sans+Pro:400,300,600' rel='stylesheet' type='text/css' />

  <link href='/favicon.png' rel='shortcut icon' />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src='/assets/javascripts/scripts.js'></script>

  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1780029-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
<body>
  <article>
    <a href="#" id="show-info">sobre &#8595;</a>
    <header>
      
        <a id="brand" href="/">
          <hgroup>
            <h1>Mergulhao.info</h1>
            <h2>Por Sylvestre Mergulhão</h2>
          </hgroup>
        </a>
      

      <form class="navbar-search pull-right visible-desktop" action="http://www.google.com/cse">
        <input type="hidden" name="cx" value="010524361318296033268:c-e-2ijyy_i" />
        <input type="hidden" name="cof" value="FORID:0" />
        <input name="q" class="search-query" type="text" placeholder="buscar por..." />
      </form>

      <p id="about"><img src="/assets/images/mergulhao-thumb.png" alt="Foto de Sylvestre Mergulhão" /> Sylvestre Mergulhão é empreendedor e programador. Fundador do <a href="http://startupdev.com.br">Startup DEV</a> e sócio da <a href="http://helabs.com.br/">HE:labs</a>.</p>

      <ul>
        <li><a href="http://startupdev.com.br" id="startupdev-link">Startup DEV</a></li>
        <li><a href="http://helabs.com.br/" id="helabs-link">HE:labs</a></li>
      </ul>
    </header>
    <hr />
    <section role="main">
      <hgroup>
  <h1>Usando o plugin contacts para baixar os contatos de seus usuários</h1>
  <h2>Postado em 27/03/2009</h2>
</hgroup>



<p>O plugin <a href='http://github.com/mislav/contacts/tree/master'>contacts</a> foi desenvolvido pelo <a href='http://mislav.uniqpath.com/'>Mislav Marohnić</a> e serve para você conseguir acesso a lista de contatos de seus usuários em serviços como Gmail, Yahoo!, Flickr e Windows Live. Calma calma! Não entrem em pânico! Para você ter acesso às informações é necessário que seu usuário autentique na página do serviço e autorize o seu site a acessar as informações.</p>

<h2 id='como_a_coisa_funciona'>Como a coisa funciona?</h2>

<p>Não é nada do outro mundo. Você coloca dentro da sua página um botão que levará o usuário para a página do serviço.</p>
<div class='center'>
<a href='http://mergulhao.info/assets/images/2009/3/14/contacts1.png'><img alt='Contacts Image 1' height='202' src='http://mergulhao.info/assets/images/2009/3/14/contacts1.png' width='480' /></a>
</div>
<p>Ao clicar no botão você entra na página do serviço, nesse caso o Google, onde se tem a opção de conceder ou de negar o acesso.</p>
<div class='center'>
<a href='http://mergulhao.info/assets/images/2009/3/14/contacts2.png'><img alt='Contacts Image 2' height='202' src='http://mergulhao.info/assets/images/2009/3/14/contacts2.png' width='480' /></a>
</div>
<p>Ao conceder o acesso, o Google envia o usuário novamente para o seu site, passando um token como parâmetro na URL. É com esse token que fazemos o acesso aos contatos do usuário.</p>
<div class='center'>
<a href='http://mergulhao.info/assets/images/2009/3/14/contacts3.png'><img alt='Contacts Image 3' height='202' src='http://mergulhao.info/assets/images/2009/3/14/contacts3.png' width='480' /></a>
</div>
<h2 id='mos__obra'>Mãos à obra</h2>

<p>Primeiro vamos criar um projeto Rails novo:</p>

<pre><code>rails mycontactsproject</code></pre>

<p>Instalar o plugin:</p>

<pre><code>script/plugin install git://github.com/mislav/contacts.git</code></pre>

<p>E gerar um controlador para tratar dos contatos:</p>

<pre><code>script/generate controller contacts</code></pre>

<p>Agora, vamos escrever uma view com o botão onde o usuário irá clicar no nosso site. Criei o arquivo <em>app/views/contacts/index.html.erb</em> com o seguinte conteúdo:</p>

<pre><code>&lt;%- form_tag Contacts::Google.authentication_url(url_for(:action =&gt; &#39;show&#39;, :only_path =&gt; false)) do -%&gt;
  &lt;%= submit_tag &quot;Clique aqui&quot; %&gt;
&lt;%- end -%&gt;</code></pre>

<p>Esse código gera um formulário com um botão de submit que faz um post para uma URL do Google. Essa URL é gerada através do método <em>authentication_url</em>. O parâmetro que foi passado é a URL de retorno que o Google irá chamar na hora de enviar o usuário de volta ao nosso site.</p>

<p>É bom lembrar que isso não tem como funcionar se você estiver utilizando a url <em>localhost</em>. Para testar localmente é preciso usar algum serviço desses de <a href='http://www.dyndns.com/'>DNS Dinâmico</a>, dessa forma o Google pode chamar uma URL que direcionará para a sua estação local.</p>

<h2 id='tratando_o_retorno_do_google'>Tratando o retorno do Google</h2>

<p>Vamos definir o método show dentro do nosso <em>ContactsController</em>. É ele que tratará o token enviado pelo Google e fará a busca dos contatos de nosso usuário:</p>

<pre><code>class ContactsController &lt; ApplicationController
  def show
    gmail = Contacts::Google.new(params[:token])
    @contacts = gmail.contacts
  end
end</code></pre>

<p>Nós passamos o token que veio na requisição para o construtor da classe <em>Contacts::Google</em> e isso nos retorna o objeto usado para recuperar os contatos. Basta chamar o método <em>contacts</em> nesse objeto e colocar o resultado, um Array de contatos, numa variável de instância que será utilizada em nossa view <em>app/views/contacts/show.html.erb</em>.</p>

<p>Na view, fazemos um loop para impressão dos contatos(na prática, você deve adaptar isso para a necessidade da sua aplicação):</p>

<pre><code>&lt;ul&gt;
  &lt;%- for contact in @contacts -%&gt;
    &lt;li&gt;&lt;%= contact.name %&gt; -  &lt;%= contact.email %&gt;&lt;/li&gt;
  &lt;%- end -%&gt;
&lt;/ul&gt;</code></pre>

<p>Basta agora subir o servidor e testar na URL: <em>http://seudominiodinamico.com:3000/contacts</em>. Se tudo deu certo, após clicar no botão <em>Clique aqui</em> e autorizar no Google, será exibida a sua lista de contatos com nome e e-mail.</p>

<p>Lembre-se que para testar esse projeto localmente você deve usar algum serviço de <a href='http://www.dyndns.com/'>DNS Dinâmico</a>, que crie um domínio válido na internet que aponte para a sua estação local. Sem isso o Google não terá como chamar uma URL que envie o navegador de volta para a sua aplicação.</p>

<p>Os arquivos completos desse projeto podem ser baixados direto do <a href='http://github.com/mergulhao/mycontactsproject/tree/master'>meu repositório no GitHub</a>.</p>


  <div class="tags">
  
    <a href="/tags/#rails">rails</a>
  
    <a href="/tags/#plugin">plugin</a>
  
  </div>

<div class="well">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'mergulhaoinfo';
      var disqus_url = 'http://mergulhao.info/2009/3/27/usando-o-plugin-contacts-para-baixar-os-contatos-de-seus-usu-rios/';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </section>
    <hr />
    <footer>
      <div id="go-to-top"><a href="#">&#8593; topo</a></div>
      <p id="copy">Copyright &copy; 2012 Mergulhao.info</p>
      <p>Veja minhas palestras no <a href="https://speakerdeck.com/u/mergulhao" rel="external">Speaker Deck</a> e me acompanhe também no twitter <a href="http://twitter.com/smergulhao" target="_blank" rel="external,nofollow">@smergulhao</a>.</p>
      <p><a href="http://pt.wikipedia.org/wiki/Rio_de_Janeiro_%28cidade%29" rel="external,nofollow">Rio de Janeiro</a>, <a href="http://pt.wikipedia.org/wiki/Brasil" rel="external,nofollow">Brasil</a>.</p>
    </footer>
  </article>
</body>
</html>